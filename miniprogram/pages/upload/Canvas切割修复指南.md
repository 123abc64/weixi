# å¾®ä¿¡å°ç¨‹åºCanvaså›¾ç‰‡åˆ‡å‰²é”™ä½é—®é¢˜å®Œæ•´ä¿®å¤æŒ‡å—

## ğŸš¨ é”™ä½é—®é¢˜æ ¹æœ¬åŸå› åˆ†æ

### 1. **Canvasæœªæ¸…ç©ºå¯¼è‡´å›¾æ¡ˆå åŠ **
```javascript
// âŒ é”™è¯¯æ–¹å¼ - æ²¡æœ‰æ¸…ç©ºCanvas
for (let i = 0; i < 8; i++) {
  ctx.drawImage(imagePath, sx, sy, sw, sh, 0, 0, dw, dh);
  // ä¸Šæ¬¡ç»˜åˆ¶çš„å›¾åƒè¿˜åœ¨Canvasä¸Šï¼Œå¯¼è‡´å›¾æ¡ˆå åŠ é‡å¤
}

// âœ… æ­£ç¡®æ–¹å¼ - æ¯æ¬¡åˆ‡å‰²å‰æ¸…ç©º
for (let i = 0; i < 8; i++) {
  ctx.clearRect(0, 0, pieceWidth, pieceHeight); // å…³é”®ï¼šæ¸…ç©ºCanvas
  ctx.drawImage(imagePath, sx, sy, sw, sh, 0, 0, dw, dh);
}
```

### 2. **drawImageåæ ‡è®¡ç®—é”™è¯¯**
```javascript
// âŒ é”™è¯¯æ–¹å¼ - ä½¿ç”¨å›ºå®šåç§»
const sx = col * 100; // å‡è®¾æ¯å—100px
const sy = row * 100; // ä¸è€ƒè™‘åŸå›¾çœŸå®å°ºå¯¸

// âœ… æ­£ç¡®æ–¹å¼ - åŸºäºåŸå›¾å°ºå¯¸è®¡ç®—
const pieceWidth = Math.floor(imageWidth / 3);
const pieceHeight = Math.floor(imageHeight / 3);
const sx = col * pieceWidth; // åŸºäºå®é™…å°ºå¯¸
const sy = row * pieceHeight;
```

### 3. **Canvaså°ºå¯¸ä¸å›¾ç‰‡ä¸åŒ¹é…**
```javascript
// âŒ é”™è¯¯æ–¹å¼ - å›ºå®šCanvaså°ºå¯¸
ctx.canvas.width = 300; // å¼ºåˆ¶300x300
ctx.canvas.height = 300;
// å¦‚æœåŸå›¾æ˜¯600x400ï¼Œä¼šå¯¼è‡´ç¼©æ”¾å’Œé”™ä½

// âœ… æ­£ç¡®æ–¹å¼ - åŠ¨æ€Canvaså°ºå¯¸
ctx.canvas.width = pieceWidth; // ä¸å•å—å°ºå¯¸ä¸€è‡´
ctx.canvas.height = pieceHeight;
```

### 4. **å¼‚æ­¥å¤„ç†æ—¶åºé—®é¢˜**
```javascript
// âŒ é”™è¯¯æ–¹å¼ - æ²¡ç­‰å¾…ç»˜åˆ¶å®Œæˆ
ctx.drawImage(...);
ctx.draw();
wx.canvasToTempFilePath({...}); // å¯èƒ½Canvasè¿˜æ²¡ç”»å®Œ

// âœ… æ­£ç¡®æ–¹å¼ - å¤šé‡å»¶è¿Ÿä¿æŠ¤
setTimeout(() => {              // å»¶è¿Ÿ1: ç¡®ä¿å›¾ç‰‡åŠ è½½
  ctx.drawImage(...);
  ctx.draw(false, () => {     // å»¶è¿Ÿ2: ç¡®ä¿ç»˜åˆ¶å®Œæˆ
    setTimeout(() => {          // å»¶è¿Ÿ3: ç¡®ä¿æ¸²æŸ“å®Œæˆ
      wx.canvasToTempFilePath(...);
    }, 300);
  });
}, 100);
```

## âœ… ä¿®å¤ç‰ˆæ ¸å¿ƒè§£å†³æ–¹æ¡ˆ

### å…³é”®ä¿®å¤ç‚¹1: å½»åº•æ¸…ç©ºCanvas
```javascript
// æ¯æ¬¡åˆ‡å‰²å‰å¿…é¡»å½»åº•æ¸…ç©º
ctx.clearRect(0, 0, pieceWidth, pieceHeight);

// é‡æ–°è®¾ç½®Canvaså°ºå¯¸ï¼Œç¡®ä¿ä¸€è‡´
ctx.canvas.width = pieceWidth;
ctx.canvas.height = pieceHeight;
```

### å…³é”®ä¿®å¤ç‚¹2: ç²¾ç¡®åæ ‡è®¡ç®—
```javascript
// åŸºäºåŸå›¾çœŸå®å°ºå¯¸çš„ç²¾ç¡®ç­‰åˆ†
const pieceWidth = Math.floor(imgW / 3);
const pieceHeight = Math.floor(imgH / 3);

// ç²¾ç¡®çš„åˆ‡å‰²èµ·å§‹åæ ‡
const sx = col * pieceWidth;  // åˆ—å· Ã— å—å®½
const sy = row * pieceHeight; // è¡Œå· Ã— å—é«˜

// æ­£ç¡®çš„drawImageè°ƒç”¨
ctx.drawImage(
  imagePath,              // å›¾ç‰‡è·¯å¾„
  sx, sy,                // æºå›¾è£å‰ªèµ·å§‹åæ ‡
  pieceWidth, pieceHeight, // æºå›¾è£å‰ªå°ºå¯¸
  0, 0,                  // Canvasç»˜åˆ¶èµ·å§‹
  pieceWidth, pieceHeight  // Canvasç»˜åˆ¶å°ºå¯¸
);
```

### å…³é”®ä¿®å¤ç‚¹3: å¼‚æ­¥å¤„ç†ä¿æŠ¤
```javascript
// ä¸‰é‡å»¶è¿Ÿç¡®ä¿å¤„ç†å®Œæˆ
setTimeout(() => {              // å»¶è¿Ÿ1: ç¡®ä¿å›¾ç‰‡åŠ è½½
  ctx.drawImage(...);
  ctx.draw(false, () => {     // å»¶è¿Ÿ2: ç¡®ä¿ç»˜åˆ¶å®Œæˆ
    setTimeout(() => {          // å»¶è¿Ÿ3: ç¡®ä¿æ¸²æŸ“å®Œæˆ
      wx.canvasToTempFilePath({
        canvasId: 'splitCanvas',
        x: 0, y: 0,
        width: pieceWidth,
        height: pieceHeight,
        destWidth: pieceWidth * pixelRatio,  // é«˜æ¸…è¾“å‡º
        destHeight: pieceHeight * pixelRatio,
        quality: 0.9
      });
    }, 300); // ç­‰å¾…æ¸²æŸ“å®Œæˆ
  });
}, 100); // ç­‰å¾…å›¾ç‰‡åŠ è½½
```

### å…³é”®ä¿®å¤ç‚¹4: è®¾å¤‡åƒç´ æ¯”é€‚é…
```javascript
// è·å–è®¾å¤‡åƒç´ æ¯”
wx.getSystemInfo({
  success: (res) => {
    const pixelRatio = res.pixelRatio || 2;
    
    // å¯¼å‡ºæ—¶è€ƒè™‘åƒç´ æ¯”
    destWidth: pieceWidth * pixelRatio,
    destHeight: pieceHeight * pixelRatio
  }
});
```

## ğŸ”§ ä½¿ç”¨ä¿®å¤ç‰ˆ

### 1. æ–‡ä»¶æ›¿æ¢
```
miniprogram/pages/upload/
â”œâ”€â”€ upload-correct.js    # æ›¿æ¢ upload.js
â”œâ”€â”€ upload-correct.wxml  # æ›¿æ¢ upload.wxml
â”œâ”€â”€ upload-correct.wxss  # æ›¿æ¢ upload.wxss
â””â”€â”€ upload-correct.json # æ›¿æ¢ upload.json
```

### 2. é¡µé¢é…ç½®
```json
{
  "pages": [
    "pages/index/index",
    "pages/upload/upload-correct"
  ]
}
```

### 3. Canvasè®¾ç½®æ£€æŸ¥
```xml
<!-- å…³é”®ï¼šCanvaså¿…é¡»è®¾ç½®æ­£ç¡® -->
<canvas 
  canvas-id="splitCanvas"
  style="position: fixed; width: 300px; height: 300px; z-index: -1;">
</canvas>
```

## ğŸ“Š åˆ‡å‰²æ•ˆæœéªŒè¯

### æ­£ç¡®åˆ‡å‰²åº”è¯¥çœ‹åˆ°ï¼š
```
åŸå›¾(å•ä¸ªå¡é€šå½¢è±¡):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤´éƒ¨   â”‚ èº«ä½“ä¸Šéƒ¨ â”‚ èº«ä½“ä¸­éƒ¨ â”‚ â† åˆ‡å‰²åæ¯ä¸ªå—æ˜¯è¿ç»­çš„
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ èº«ä½“ä¸‹éƒ¨â”‚ å·¦è…¿     â”‚ å³è…¿     â”‚   æ²¡æœ‰é‡å¤æˆ–æ–­è£‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¦è„š     â”‚ å³è„š     â”‚ ç©º        â”‚   èƒ½å®Œç¾æ‹¼æ¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é”™è¯¯åˆ‡å‰²ä¼šå‡ºç°ï¼š
```
âŒ é‡å¤é—®é¢˜: å·¦ä¸Šè§’å’Œå·¦ä¸‹è§’éƒ½æœ‰å®Œæ•´å¤´éƒ¨
âŒ æ–­è£‚é—®é¢˜: èº«ä½“éƒ¨åˆ†æ˜¾ç¤ºä¸è¿ç»­ï¼Œç›¸é‚»å—æ¥ä¸ä¸Š
âŒ é”™ä½é—®é¢˜: å›¾æ¡ˆè¾¹ç¼˜å¯¹ä¸é½
```

## ğŸ¯ æµ‹è¯•éªŒè¯æ­¥éª¤

### 1. ä¸Šä¼ æµ‹è¯•å›¾ç‰‡
- å»ºè®®ä½¿ç”¨800x800åƒç´ çš„å•ä¸ªå¡é€šå½¢è±¡
- å›¾æ¡ˆæ¸…æ™°ï¼Œè¾¹ç•Œåˆ†æ˜

### 2. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—
```
=== å›¾ç‰‡ä¿¡æ¯ ===
è·¯å¾„: http://tmp/xxx.jpg
å°ºå¯¸: 800 x 800
ç±»å‹: jpeg
å¤§å°: 156.32KB

=== åˆ†å‰²å‚æ•° ===
åŸå›¾å°ºå¯¸: 800 x 800
å•å—å°ºå¯¸: 266 x 266

=== åˆ‡å‰²ç¬¬1å— ===
ä½ç½®: ç¬¬1è¡Œ ç¬¬1åˆ—
æºå›¾åˆ‡å‰²åŒºåŸŸ: 0, 0, 266, 266
Canvasç»˜åˆ¶å°ºå¯¸: 266, 266
âœ… ç¬¬1å—åˆ‡å‰²æˆåŠŸ: tmp/xxx_1.jpg
```

### 3. æ£€æŸ¥åˆ‡å‰²ç»“æœ
- 8ä¸ªæ‹¼å›¾å—éƒ½æœ‰å†…å®¹
- æ¯å—éƒ½æ˜¯åŸå›¾çš„è¿ç»­éƒ¨åˆ†
- æ²¡æœ‰é‡å¤æˆ–ç¼ºå¤±çš„å›¾æ¡ˆ
- æ‹¼å›¾å—è¾¹ç¼˜èƒ½å¯¹é½

## ğŸš€ å°ç¨‹åºç‰¹æœ‰æ³¨æ„äº‹é¡¹

### 1. å›¾ç‰‡è·¯å¾„å¤„ç†
```javascript
// å¿…é¡»ä½¿ç”¨ä¸´æ—¶è·¯å¾„
wx.chooseImage({
  success: (res) => {
    const tempPath = res.tempFilePaths[0]; // æ­£ç¡®
    // ä¸è¦ä½¿ç”¨æœ¬åœ°ç›¸å¯¹è·¯å¾„
  }
});
```

### 2. Canvasé™åˆ¶
- Canvaså°ºå¯¸ä¸å®œè¿‡å¤§(å»ºè®®æœ€å¤§1200px)
- å›¾ç‰‡å¯¼å‡ºæœ‰å¤§å°é™åˆ¶
- å¼‚æ­¥æ“ä½œéœ€è¦é€‚å½“çš„å»¶è¿Ÿ

### 3. å†…å­˜ç®¡ç†
```javascript
// åŠæ—¶æ¸…ç†
onUnload: function() {
  if (this.data.timer) {
    clearInterval(this.data.timer);
  }
}
```

### 4. é”™è¯¯å¤„ç†
```javascript
// è¯¦ç»†çš„é”™è¯¯åˆ†ç±»
if (err.errMsg.includes('canvas')) {
  errorMsg = 'Canvaså¤„ç†å¤±è´¥';
} else if (err.errMsg.includes('tempFilePath')) {
  errorMsg = 'å›¾ç‰‡å¯¼å‡ºå¤±è´¥';
}
```

## ğŸ® ä¿®å¤åæ•ˆæœ

ä½¿ç”¨ä¿®å¤ç‰ˆåï¼Œä½ çš„æ‹¼å›¾æ¸¸æˆå°†ï¼š
- âœ… å®Œå…¨æ¶ˆé™¤å›¾æ¡ˆé‡å¤é—®é¢˜
- âœ… è§£å†³åŒºåŸŸé”™ä½å’Œæ–­è£‚
- âœ… ç¡®ä¿æ¯ä¸ªæ‹¼å›¾å—æ˜¯è¿ç»­çš„å›¾ç‰‡éƒ¨åˆ†
- âœ… æ”¯æŒå®Œç¾æ‹¼æ¥è¿˜åŸåŸå›¾
- âœ… é€‚é…æ‰€æœ‰å¾®ä¿¡å°ç¨‹åºè®¾å¤‡å’Œç¯å¢ƒ

ç°åœ¨å¯ä»¥æ”¾å¿ƒä¸Šä¼ å›¾ç‰‡ï¼Œäº«å—å®Œç¾çš„æ‹¼å›¾ä½“éªŒï¼