<view class="container">
  <!-- 页面标题 -->
  <view class="header">
    <text class="title">自定义拼图游戏</text>
    <text class="subtitle">上传图片，生成专属拼图</text>
  </view>

  <!-- 图片上传区域 -->
  <view class="upload-section" wx:if="{{!gameStarted}}">
    <view class="upload-box" bindtap="chooseImage">
      <image wx:if="{{uploadedImage}}" src="{{uploadedImage}}" class="preview-image" mode="aspectFit"></image>
      <view wx:else class="upload-placeholder">
        <text class="upload-icon">📷</text>
        <text class="upload-text">点击上传图片</text>
        <text class="upload-tips">支持JPG、PNG格式</text>
      </view>
    </view>
    
    <button wx:if="{{uploadedImage}}" class="start-btn" bindtap="startGame" disabled="{{processing}}">
      {{processing ? '处理中...' : '开始拼图'}}
    </button>
  </view>

  <!-- 游戏区域 -->
  <view class="game-section" wx:if="{{gameStarted}}">
    <!-- 游戏信息 -->
    <view class="game-info">
      <view class="info-item">
        <text class="info-label">步数：</text>
        <text class="info-value">{{steps}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">时间：</text>
        <text class="info-value">{{formatTime}}</text>
      </view>
    </view>

    <!-- 游戏控制 -->
    <view class="game-controls">
      <button class="control-btn" bindtap="toggleNumbers">{{showNumbers ? '隐藏' : '显示'}}数字</button>
      <button class="control-btn restart-btn" bindtap="restartGame">重新开始</button>
    </view>

    <!-- 拼图区域 -->
    <view class="puzzle-container">
      <view class="puzzle-grid">
        <view 
          wx:for="{{puzzlePieces}}" 
          wx:key="id" 
          class="puzzle-piece {{item.isEmpty ? 'empty' : ''}} {{showNumbers ? 'show-number' : ''}}"
          style="{{item.isEmpty ? '' : 'background-image: url(' + item.imageUrl + '); background-size: cover; background-position: center;'}}"
          data-index="{{index}}"
          bindtap="movePiece">
          <text wx:if="{{showNumbers && !item.isEmpty}}" class="piece-number">{{item.correctNumber}}</text>
          <text wx:if="{{item.isEmpty}}" class="empty-mark">空</text>
        </view>
      </view>
    </view>

    <!-- 返回按钮 -->
    <button class="back-btn" bindtap="backToUpload">返回上传</button>
  </view>

  <!-- 完成游戏弹窗 -->
  <view class="victory-modal" wx:if="{{showVictory}}">
    <view class="modal-mask"></view>
    <view class="modal-content victory-content">
      <view class="victory-header">
        <text class="victory-icon">🎉</text>
        <text class="victory-title">恭喜完成！</text>
      </view>
      <view class="victory-stats">
        <view class="stat-item">
          <text class="stat-value">{{steps}}</text>
          <text class="stat-label">步数</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{formatTime}}</text>
          <text class="stat-label">用时</text>
        </view>
      </view>
      <view class="victory-actions">
        <button class="victory-btn primary" bindtap="restartGame">再玩一次</button>
        <button class="victory-btn secondary" bindtap="backToUpload">上传新图</button>
      </view>
    </view>
  </view>

  <!-- 加载提示 -->
  <view class="loading-overlay" wx:if="{{processing}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">{{processingText}}</text>
      <view class="progress-bar" wx:if="{{showProgress}}">
        <view class="progress-fill" style="width: {{progressPercent}}%"></view>
      </view>
    </view>
  </view>

  <!-- 关键：正确的Canvas设置 -->
  <!-- 必须设置正确的Canvas尺寸，避免错位 -->
  <canvas 
    canvas-id="splitCanvas" 
    style="position: fixed; top: -9999px; left: -9999px; width: 300px; height: 300px;"
    bindtouchstart="handleCanvasTouch"
  ></canvas>
</view>